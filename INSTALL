#!/usr/bin/env bash

set -e
shopt -s expand_aliases

banner="
     _                   ___  _  _
    | |          _      / __)(_)| |
  __| |  ___   _| |_  _| |__  _ | |  _____   ___
 / _  | / _ \ (_   _)(_   __)| || | | ___ | /___)
( (_| || |_| |  | |_   | |   | || | | ____||___ |
 \____| \___/    \__)  |_|   |_| \_)|_____)(___/
   
A one-click install script to configure working environments.

Run this script anytime over the Internet: wget -qO- https://raw.githubusercontent.com/freitzzz/dotfiles/master/INSTALL | bash
"

echo "$banner"

# 0. Download dotfiles framework if executed over the Internet

if [ ! -d .git ] || [ ! -f INSTALL ];
then
    sudo apt-get update
    sudo apt-get install git
    git clone https://github.com/freitzzz/dotfiles

    cd dotfiles
fi

dependencies_source="DEPENDENCIES"

# 1. Install required dependencies

echo "ยบ Installing required dependencies..."
echo "~~~~~~~~"

# set default english locale since that's required in the grep condition
src_lang=$LC_ALL
LC_ALL=C

while read -r dependency;
do
    if apt-cache policy $dependency | grep 'Installed: (none)'; then
      echo "> Installing $dependency"
      sudo apt-get install -y $dependency
    else
      echo "> $dependency is already installed"
    fi
done < <( cat "$dependencies_source" )

# restore source language
LC_ALL=$src_lang

echo "ยบ All dependencies installed!"
echo "~~~~~~~~"

# 2. Run install script targeting repository modules

echo "ยบ Installing modules using dotfiles framework..."
echo "~~~~~~~~"

python3.10 run.py

echo "~~~~~~~~"
echo "ยบ All done! Your work environment is now tuned."